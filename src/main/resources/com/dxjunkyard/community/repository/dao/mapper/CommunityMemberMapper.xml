<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dxjunkyard.community.repository.dao.mapper.CommunityMemberMapper">
    <!-- Insert or Update CommunityMember -->
    <insert id="insertOrUpdateCommunityMember">
        INSERT INTO CommunityMembers (
            community_id,
            user_id,
            role_id,
            status,
            fav_flg
        )
        VALUES (
                   #{communityId},
                   #{userId},
                   #{role, typeHandler=com.dxjunkyard.community.config.mybatis.CommunityRoleTypeHandler},
                   #{status},
                   #{fav}
               )
            ON DUPLICATE KEY UPDATE
                                role_id = #{role, typeHandler=com.dxjunkyard.community.config.mybatis.CommunityRoleTypeHandler},
                                status = #{status},
                                fav_flg = #{fav};
    </insert>
    <!-- Select CommunityMember by communityId and userId -->
    <resultMap id="CommunityMemberResult" type="com.dxjunkyard.community.domain.CommunityMembers">
        <result column="community_id" property="communityId"/>
        <result column="user_id" property="userId"/>
        <result column="role_id" property="role" javaType="com.dxjunkyard.community.domain.CommunityRole"
                typeHandler="com.dxjunkyard.community.config.mybatis.CommunityRoleTypeHandler"/>
        <result column="status" property="status"/>
        <result column="fav_flg" property="fav"/>
    </resultMap>
    <select id="selectCommunityMember" resultMap="CommunityMemberResult">
        SELECT
            community_id,
            user_id,
            role_id,
            status,
            fav_flg
        FROM CommunityMembers
        WHERE community_id = #{communityId}
          AND user_id = #{userId}
    </select>
    <insert id="addCommunityMember">
        insert into CommunityMembers(
            community_id,
            user_id,
            role_id,
            status,
            fav_flg)
        values (
                   #{community_id},
                   #{user_id},
                   #{role_id, typeHandler=com.dxjunkyard.community.config.mybatis.CommunityRoleTypeHandler},
                   #{status},
                   #{fav}
               )
    </insert>

    <update id="updateRole">
        UPDATE CommunityMembers
        SET role_id = #{role_id, typeHandler=com.dxjunkyard.community.config.mybatis.CommunityRoleTypeHandler}
        WHERE community_id = #{community_id}
          AND user_id = #{user_id}
    </update>

    <delete id="deleteCommunityMember">
        DELETE FROM CommunityMembers
        WHERE community_id = #{community_id}
          AND user_id = #{user_id}
    </delete>
</mapper>
